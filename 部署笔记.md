# Grok2API 部署与配置完整指南

> 从 Token 获取到图片显示问题解决的完整实战笔记

---

## 📋 目录

1. [环境准备](#1-环境准备)
2. [项目运行](#2-项目运行)
3. [Token 获取](#3-token-获取)
4. [解决 403 错误](#4-解决-403-错误)
5. [解决图片显示问题](#5-解决图片显示问题)
6. [API 使用](#6-api-使用)
7. [常见问题](#7-常见问题)

---

## 1. 环境准备

### 前置要求

- **Python**: 3.10+ （推荐 3.11+）
- **包管理器**: `uv`（推荐）或 `pip`
- **系统**: Windows / Linux / macOS

### 安装 uv 包管理器（推荐）

**Windows (PowerShell)**:
```powershell
powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"
```

**Linux / macOS**:
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

> ⚠️ **注意**: 安装后需要 **重启终端窗口** 才能使用 `uv` 命令

---

## 2. 项目运行

### 2.1 克隆项目

```bash
git clone https://github.com/Tomiya233/grok2api.git
cd grok2api
```

### 2.2 安装依赖并运行

**方式一：使用 uv（推荐）**

```bash
# Windows 用户如果 uv 未加入环境变量，使用完整路径
C:\Users\Administrator\.local\bin\uv.exe sync

# 运行服务
C:\Users\Administrator\.local\bin\uv.exe run python main.py
```

**方式二：使用传统 pip**

```bash
# 创建虚拟环境（可选）
python -m venv venv
.\venv\Scripts\activate  # Windows
source venv/bin/activate  # Linux/Mac

# 安装依赖
pip install -r requirements.txt

# 运行服务
python main.py
```

### 2.3 验证启动

看到以下日志表示启动成功：

```
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
[Grok2API] 应用启动成功
```

访问管理后台：http://127.0.0.1:8000/login
- **默认账号**: `admin`
- **默认密码**: `admin`

---

## 3. Token 获取

### 3.1 什么是 Token？

Grok2API 需要的 Token 是 **X.com (Twitter) 的登录 Cookie**，具体是 `sso` 和 `sso-rw` 字段。

### 3.2 获取方法（浏览器开发者工具）

**步骤 1：登录 X.com**

1. 打开浏览器，访问 https://x.com/ 并登录
2. 访问 Grok 页面：https://x.com/i/grok

**步骤 2：打开开发者工具**

- 按 `F12` 或 `Ctrl+Shift+I`（Mac: `Cmd+Option+I`）
- 切换到 **Application** / **Storage** / **应用** 标签页

**步骤 3：获取 Cookie**

1. 展开左侧的 **Cookies**
2. 点击 `https://x.com`
3. 找到以下两个 Cookie：
   - `sso` - 复制值
   - `sso-rw` - 复制值（可选）

**步骤 4：组合格式**

完整格式：`sso-rw=YOUR_SSO_RW_VALUE;sso=YOUR_SSO_VALUE`

或者只使用 `sso` 值也可以（系统会自动处理）。

### 3.3 添加到系统

1. 访问管理后台：http://127.0.0.1:8000/manage
2. 点击 **Token 管理** 标签
3. 点击 **批量添加** 按钮
4. 粘贴您的 Cookie 值
5. 可选：添加备注（如 "主账号"）
6. 点击提交

### 3.4 验证 Token

添加后，点击 **测试** 按钮验证 Token 是否有效。

> ⚠️ 如果出现 **403 错误**，请继续下一步。

---

## 4. 解决 403 错误

### 4.1 问题原因

X.com 对 API 访问有严格的 Cloudflare 反爬虫保护，直接访问会被拦截。

错误日志示例：
```
[Token] 获取限制失败: 403
[Token] IP被Block，请: 1.更换IP 2.使用代理 3.配置CF值
```

### 4.2 解决方案 1：配置代理（推荐）⭐

**准备代理**

使用 Clash、V2Ray、Shadowsocks 等代理工具，确保代理已启动。

常见代理端口：
- Clash: `http://127.0.0.1:7890` 或 `7897`
- V2Ray: `socks5://127.0.0.1:1080`

**配置步骤**

1. 访问管理后台：http://127.0.0.1:8000/manage
2. 点击 **Setting 配置** 标签
3. 找到 **代理设置** 区域
4. 在 `Proxy Url (服务代理)` 填入：
   ```
   http://127.0.0.1:7897
   ```
   （根据您的实际端口调整）
5. 点击 **保存配置**

**重启服务**（重要！⚠️）

配置修改后必须重启服务才能生效：

```bash
# 按 Ctrl+C 停止服务
# 然后重新运行
C:\Users\Administrator\.local\bin\uv.exe run python main.py
```

**验证**

查看启动日志，应显示：
```
[ProxyPool] 使用静态代理: http://127.0.0.1:7897
```

### 4.3 解决方案 2：配置 cf_clearance（可选）

**获取 cf_clearance**

1. 在浏览器打开 https://x.com/i/grok
2. 按 `F12` 打开开发者工具
3. **Application** → **Cookies** → `https://x.com`
4. 找到 `cf_clearance`，复制值

**配置**

在管理后台 **Setting 配置** 中：
- 找到 `CF Clearance` 字段
- 粘贴刚才复制的值
- 保存并重启服务

> 📌 **注意**: `cf_clearance` 有效期较短（几小时到几天），需定期更新。

### 4.4 测试是否成功

重启服务后，前往 **Token 管理**，点击 **测试** 按钮。

如果成功，会显示剩余次数（如 `剩余: 80`）。

---

## 5. 解决图片显示问题

### 5.1 问题现象

在客户端（如 Cherry Studio）中请求图片生成，返回的图片无法显示，显示为破损图标。

### 5.2 问题原因

项目的 `base_url` 配置为空，导致图片 URL 生成不完整。

### 5.3 解决方法

**方式一：管理后台修改**

1. 访问管理后台：http://127.0.0.1:8000/manage
2. 点击 **Setting 配置** 标签
3. 找到 `Base Url` 字段
4. 填入您的服务访问地址：
   - **本地测试**: `http://127.0.0.1:8000`
   - **局域网访问**: `http://192.168.1.100:8000`（替换为您的实际 IP）
   - **公网部署**: `https://yourdomain.com`
5. 保存配置
6. **重启服务**（必须！）

**方式二：直接修改配置文件**

编辑 `data/setting.toml`：

```toml
[global]
base_url = "http://127.0.0.1:8000"  # 修改这里
```

保存后重启服务。

### 5.4 验证

重启服务后，重新请求图片生成，图片应该能正常显示。

图片访问路径示例：
```
http://127.0.0.1:8000/images/temp/xxxxx.png
```

---

## 6. API 使用

### 6.1 创建 API Key

1. 访问管理后台
2. 点击 **Key 管理** 标签
3. 点击 **创建新 Key** 按钮
4. 输入备注名称（如 "我的客户端"）
5. 复制生成的 Key（格式：`sk-xxxxxx`）

### 6.2 Base URL 和端点

| 用途         | URL                                        |
|--------------|--------------------------------------------|
| Base URL     | `http://127.0.0.1:8000/v1`                |
| 聊天对话     | `http://127.0.0.1:8000/v1/chat/completions` |
| 模型列表     | `http://127.0.0.1:8000/v1/models`          |

### 6.3 支持的模型

| 模型名称               | 特性                        |
|------------------------|----------------------------|
| `grok-4`               | 标准模型，支持图像、联网    |
| `grok-4-fast`          | 快速模型                   |
| `grok-4-expert`        | 专家模型（消耗 4 次额度）   |
| `grok-4.1-thinking`    | 深度思考模型               |
| `grok-imagine-0.9`     | 视频生成模型               |

### 6.4 使用示例

**curl 测试**

```bash
curl http://127.0.0.1:8000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer sk-你的API_KEY" \
  -d '{
    "model": "grok-4-fast",
    "messages": [
      {"role": "user", "content": "你好"}
    ]
  }'
```

**Python (OpenAI SDK)**

```python
import openai

client = openai.OpenAI(
    base_url="http://127.0.0.1:8000/v1",
    api_key="sk-你的API_KEY"
)

response = client.chat.completions.create(
    model="grok-4-fast",
    messages=[{"role": "user", "content": "介绍一下你自己"}]
)

print(response.choices[0].message.content)
```

**第三方客户端配置（如 Cherry Studio）**

- **API Base URL**: `http://127.0.0.1:8000/v1`
- **API Key**: `sk-你的API_KEY`
- **Model**: `grok-4-fast`

---

## 7. 常见问题

### 7.1 端口被占用

**错误**:
```
ERROR: [Errno 10048] error while attempting to bind on address ('0.0.0.0', 8000)
```

**解决**:
```powershell
# 查找占用 8000 端口的进程
netstat -ano | findstr :8000

# 停止进程（替换为实际 PID）
Stop-Process -Id <PID> -Force
```

### 7.2 uv 命令找不到

**问题**: 安装 uv 后仍然提示 "无法识别"

**解决**:
1. 重启终端窗口
2. 或使用完整路径：`C:\Users\Administrator\.local\bin\uv.exe`
3. 或将 `C:\Users\Administrator\.local\bin` 添加到系统 PATH

### 7.3 代理配置不生效

**问题**: 配置代理后仍然 403

**解决**:
1. 确认代理工具已启动
2. 确认代理端口正确（Clash 常用 7890/7897）
3. **必须重启服务**（修改配置不会自动生效）
4. 检查启动日志是否显示 `[ProxyPool] 使用静态代理`

### 7.4 Token 失效

**现象**: Token 测试失败，或调用时提示 401

**解决**:
1. Token 会过期，需要重新从浏览器获取
2. 删除旧 Token，添加新 Token
3. 确保从已登录的浏览器获取

### 7.5 图片仍然不显示

**检查清单**:
- [ ] `base_url` 已正确配置
- [ ] 已重启服务
- [ ] 检查图片 URL 是否完整（应包含 `http://127.0.0.1:8000/images/...`）
- [ ] 防火墙是否阻止了访问

### 7.6 调用次数限制

**免费账号限制**: 80 次 / 20 小时

**解决**:
- 添加多个账号的 Token，系统会自动负载均衡
- 使用 `grok-4-expert` 等模型会消耗更多次数（4 次）
- 等待 20 小时后额度重置

---

## 🎯 快速检查清单

部署完成后，按照以下清单验证：

- [ ] 服务成功启动（端口 8000）
- [ ] 代理配置正确（启动日志显示代理地址）
- [ ] Token 测试成功（显示剩余次数）
- [ ] `base_url` 已配置为 `http://127.0.0.1:8000`
- [ ] API Key 已创建
- [ ] 能成功调用聊天接口
- [ ] 图片生成能正常显示

---

## 📚 相关链接

- **项目地址**: https://github.com/Tomiya233/grok2api
- **原项目**: https://github.com/VeroFess/grok2api
- **Grok 官网**: https://x.com/i/grok

---

## 🔄 版本记录

- **2026-02-02**: 初始版本，记录完整部署流程

---

**祝您使用愉快！🎉**
